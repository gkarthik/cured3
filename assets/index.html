<html>
<head>
  <script type="text/javascript" src="./js/jquery-1.10.1.js"></script>
  <script type="text/javascript" src="./js/underscore.js"></script>
  <script type="text/javascript" src="./js/backbone.js"></script>
  <script type="text/javascript" src="./js/backbone-relational.js"></script>
  <style>
    <!-- @Karthik lets try to keep the css formatted this way -->
    body {
      font-family:Arial;
    }

    h2 {
      float:left;
      width:70%;
      margin:0px;
      padding:0px;
    }

    .key {
      color:blue;
    }

    .string {
      color:green;
    }

    #sidebar {
      width:30%;
      float:right;
    }

    #json_structure {
      width:70%;
      float:left;
    }

    #nodelist {
      list-style:none;
    }

    #nodelist li {
      margin:5px;
      background:#727272;
      color:#FFF;
      float:left;
      width:90%;
      padding:5%;
      border-radius:10px;
    }

    #nodelist li span {
      cursor:pointer;
      float:right;
      display:block;
      width:auto;
      margin:0px 5px;
    }
  </style>
</head>
<body>
  <h2>JSON</h2>
  <div id='json_structure'></div>
  <div id="sidebar"><h2>Add/Remove Nodes</h2><ul id="nodelist"></ul></div>

  <script>
    //
    //-- Defining our collections
    //
    NodeCollection = Backbone.Collection.extend({
        model : Node,
        initialize: function() {
          this.on("add", function() {
            $json_structure.html( prettyPrint(this.toJSON()) );
          });

          this.on("remove",function() {
            $json_structure.html( prettyPrint(this.toJSON()) );
          });

          this.counter = 0;
        }
    });

    //
    //-- Defining our models
    //
    Node = Backbone.RelationalModel.extend({
      defaults : {
        'name' : ''
      },
      initialize: function() {
        network_coll.add(this);
        this.bind("add:children", function() {
          $json_structure.html( prettyPrint(network_coll.toJSON()) );
        });
      },

      relations: [{
        type: Backbone.HasMany,
        key: 'children',
        relatedModel: 'Node',
        reverseRelation: {
          key: 'parentNode',
          includeInJSON: false
        }
      }]
    });

    //
    //-- Defining our views
    //
    NodeRow = Backbone.View.extend({
      //-- View to manipulate each single node
      tagName: 'li',
      events: {
        'click span.addchildren'  : 'addChildren',
        'click span.delete'       : 'remove'
      },

      initialize: function(){
        _.bindAll(this, 'render', 'remove', 'addChildren');

        this.model.bind('change', this.render);
        this.model.bind('remove', this.remove);
      },

      render: function(){
        $(this.el).html(this.model.get('name')+'<span class="addchildren">Add Children</span><span class="delete">Remove</span>');
        return this;
      },

      remove: function(){
        if(network_coll.length > 1) {
          $(this.el).remove();
          this.model.destroy();
        }
      },

      addChildren: function(){
        this.model.get('children').add({'name' : 'Node'+network_coll.counter});
        network_coll.counter++;
      }
    });

    NodeList = Backbone.View.extend({
      //-- View to manipulate and display list of all nodes in collection
      el: $('#nodelist'),	
      initialize: function() {
        this.collection.bind('add', this.onModelAdded);
      },

      AddModel: function(){
        var tempNode = new Node({'name' : 'Node'+network_coll.counter});
        network_coll.counter++;
        var newNodeRow = new NodeRow({ model: tempNode });
        $('ul', this.el).append(newNodeRow.render().el);
      },

      onModelAdded: function(addedModel) {
        var newNodeRow = new NodeRow({ model: addedModel });
        $('ul',this.el).append(newNodeRow.render().el);
      }
    });

    //
    //-- Utilities / Helpers
    //

//-- Pretty Print JSON.
//-- @Karthik do you have a reference/source for this function?
function prettyPrint(json) {
    if (typeof json != 'string') {
         json = JSON.stringify(json, undefined, 2);
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
	return '<span class="' + cls + '">' + match + '</span>';
    });
  }

    //
    //-- App init!
    //
    var $json_structure = $('#json_structure'),
        network_coll = new NodeCollection,
        MyNodeList = new NodeList({ collection: network_coll }),
        node = new Node({'name':'ROOT'});

    //-- TASKS / IDEAS:
    //-- Might be fun to have a 'autogenerate network with X nodes and X tiers' random function, not exactly
    //-- relevant to the exact task at hand but might make you more comertable with how to leverage this collection/model structure

    //-- To note, please look at the formatting differences I made, we want to make sure the code says clean (and to help with the fact that I need to read it)

    //-- I hate html in long strings! Have you ever used a templating system? Underscore has one built right in: http://underscorejs.org/#template
    //-- (TODO) convert the views to using them.

    //-- (TODO) Question to ask yourself about network_coll.counter, do you really need it? Hint: http://puff.me.uk/ss/B0DvC.png

    //-- (TODO) Look at todomvc.com ( http://puff.me.uk/ss/onq8U.png ) and play with how they double-click to edit the task name. 
    //-- I want to be able to do the same for NodeNames then have an event to update the network on input or blur events of that input element

    //-- (TODO) Can we get some twitter bootstrap <3?

    //-- AWESOME START!

</script>

</body>
</html>
